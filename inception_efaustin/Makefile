# My var(s)
NAME			=	inception
RM				=	rm -rf
MK				=	mkdir -p

TEMP_ENV		=	./srcs/.env.temp
ENV_FILES		=	./srcs/.env ./srcs/.env.credentials

DCK				=	docker
DCPS			=	docker-compose
DCPS_CMD		=	$(DCPS) --env-file $(TEMP_ENV) -f ./srcs/docker-compose.yml

DT_DIR			=	/home/efaustin/data
DB_DIR			=	$(DT_DIR)/mariadb
WP_DIR			=	$(DT_DIR)/wordpress
ADMINER_DIR		=	$(DT_DIR)/adminer
SECRETS_DIR		=	./secrets

SENHAS_FILES	=	secrets/credentials.txt secrets/db_password.txt secrets/db_root_password.txt srcs/.env.credentials

# My rule(s)
all: check_files mkfolder build up

check_files:
	@echo "\nğŸ” Verificando a existÃªncia das credenciais..."
	@for file in $(SENHAS_FILES); do \
		if [ ! -f $$file ]; then \
			echo "âŒ Arquivo obrigatÃ³rio das credenciais nÃ£o encontrado: $$file"; \
			exit 1; \
		fi; \
	done
	@echo "âœ… Todos os arquivos obrigatÃ³rios das credenciais existem."

mkfolder:
	@echo "\nğŸ“ Criando os diretÃ³rios dos volumes..."
	@$(MK) $(DT_DIR)
	@$(MK) $(DB_DIR)
	@$(MK) $(WP_DIR)
	@$(MK) $(ADMINER_DIR)
	@$(MK) $(SECRETS_DIR)
	@echo "âœ… DiretÃ³rios dos volumes prontos com permissÃµes."

build:
	@cat $(ENV_FILES) > $(TEMP_ENV)
	@echo "\nğŸ”¨ Construindo imagens do Docker..."
	@$(DCPS_CMD) build
	@echo "âœ… Imagens do Docker construidas"

up:
	@echo "\nğŸš€ Iniciando serviÃ§os..."
	@$(DCPS_CMD) up -d

down:
	@echo "\nğŸ›‘ Parando serviÃ§os..."
	@$(DCPS_CMD) down

remove: down
	@echo "\nğŸ—‘ï¸ Removendo containers e volumes..."
	@$(DCK) volume prune -f
	@$(DCK) container prune -f

stop:
	@echo "\nâ›” Parando containers..."
	@$(DCPS_CMD) stop

start:
	@echo "\nâ–¶ï¸ Iniciando containers..."
	@$(DCPS_CMD) start

restart: stop start

clean: stop down
	@$(RM) $(TEMP_ENV)

fclean: clean remove

re: fclean all

list:
	@echo "\nğŸ“¦ Listando containers:"
	@$(DCK) ps -a
	@echo "\nğŸ–¼ï¸ Listando imagens:"
	@$(DCK) images -a

logs:
	@echo "\nğŸ“œ Exibindo logs dos serviÃ§os..."
	@echo "\n================ mariadb ================"
	@cd srcs && $(DCPS) logs mariadb
	@echo "\n================ wordpress =============="
	@cd srcs && $(DCPS) logs wordpress
	@echo "\n================ nginx =================="
	@cd srcs && $(DCPS) logs nginx
	@echo "\n================ adminer ================"
	@cd srcs && $(DCPS) logs adminer
	@echo "\n================ website ================"
	@cd srcs && $(DCPS) logs website

status:
	@echo "\nğŸ” Status dos containers:"
	@$(DCK) ps

help:
	@echo "Use: make [OPÃ‡ÃƒO] | OpÃ§Ã£o padrÃ£o: all"
	@echo "\nOpÃ§Ãµes:"
	@echo "\nall	= ğŸ”¨ construir e ğŸš€ iniciar o projeto"
	@echo "clean	= â›” parar os servicos e ğŸ—‘ï¸ limpÃ¡-los"
	@echo "fclean	= â›” parar e ğŸ—‘ï¸ limpar tudo"
	@echo "re	= ğŸ”¨ reconstruir e ğŸš€ reiniciar tudo"
	@echo "\ncheck_files = ğŸ” Verifica a existÃªncia das credenciais"
	@echo "mkfolder    = ğŸ“ cria os diretÃ³rios dos volumes"
	@echo "build	    = ğŸ”¨ construindo imagens do Docker"
	@echo "up	    = ğŸš€ inicia os serviÃ§os em modo detached"
	@echo "down	    = ğŸ›‘ para e remove os serviÃ§os"
	@echo "remove	    = ğŸ—‘ï¸ remove containers e volumes"
	@echo "\nstop	= â›” para os containers"
	@echo "start	= â–¶ï¸ inicia os containers"
	@echo "restart	= â›” para e volta a â–¶ï¸ iniciar os containers"
	@echo "\nlist	= lista ğŸ“¦ containers e ğŸ–¼ï¸ imagens"
	@echo "logs	= exibi ğŸ“œ logs dos serviÃ§os"
	@echo "status	= mostra ğŸ” status dos containers"

# Alvos que nÃ£o sÃ£o arquivos
.PHONY: all check_files mkfolder build up down remove stop start restart clean fclean re list logs status help
